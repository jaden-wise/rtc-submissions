<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Return to Client Scanner</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 700px;
    }

    h2 { margin-bottom: 10px; }
    h3 { margin-top: 30px; margin-bottom: 6px; }

    select, input {
      padding: 10px;
      font-size: 14px;
      width: 100%;
      max-width: 400px;
    }

    .scan-input {
      padding: 14px;
      font-size: 18px;
      margin-bottom: 6px;
      width: 100%;
    }

    button {
      padding: 8px 12px;
      margin-right: 6px;
      font-size: 14px;
    }

    ul {
      padding-left: 20px;
      margin-top: 6px;
    }

    li.duplicate {
      color: #b45309;
      font-weight: bold;
      background: #fff7ed;
      padding: 4px 6px;
      border-radius: 4px;
      margin-bottom: 2px;
    }

    .hidden { display: none; }
    .section { margin-top: 16px; }
  </style>
</head>

<body>

<h2>Return to Client â€“ Package Scanning</h2>

<label>Warehouse Site *</label>
<select id="siteSelect">
  <option value="">Select siteâ€¦</option>
</select>

<br><br>

<label>Client *</label>
<select id="clientSelect">
  <option value="">Select clientâ€¦</option>
</select>

<br><br>

<label>Returned By *</label>
<input id="personSelect" list="personList" placeholder="Start typing a nameâ€¦" />
<datalist id="personList"></datalist>

<h3>What type of packages are being returned to the client?</h3>
<label><input type="checkbox" value="nonVeho" /> Non-Veho Label</label><br>
<label><input type="checkbox" value="damaged" /> Damaged Packages</label><br>
<label><input type="checkbox" value="undeliverable" /> Undeliverable Packages</label>

<div id="nonVeho" class="section hidden">
  <h3>Non-Veho Label</h3>
  <input class="scan-input" placeholder="Scan packagesâ€¦" />
  <button onclick="undo('nonVeho')">Undo</button>
  <button onclick="clearSection('nonVeho')">Clear</button>
  <p>Captured (<span class="count">0</span>)</p>
  <ul class="list"></ul>
</div>

<div id="damaged" class="section hidden">
  <h3>Damaged Packages</h3>
  <input class="scan-input" placeholder="Scan packagesâ€¦" />
  <button onclick="undo('damaged')">Undo</button>
  <button onclick="clearSection('damaged')">Clear</button>
  <p>Captured (<span class="count">0</span>)</p>
  <ul class="list"></ul>
</div>

<div id="undeliverable" class="section hidden">
  <h3>Undeliverable Packages</h3>
  <input class="scan-input" placeholder="Scan packagesâ€¦" />
  <button onclick="undo('undeliverable')">Undo</button>
  <button onclick="clearSection('undeliverable')">Clear</button>
  <p>Captured (<span class="count">0</span>)</p>
  <ul class="list"></ul>
</div>

<hr>

<label>UPS Tracking Number *</label>
<input type="text" id="upsTracking" />

<br><br>

<button id="submitBtn">Submit Return to Client</button>

<script>
/* =========================================================
   CLOUDFLARE PROXY
========================================================= */
const API_BASE = "https://rtc-api-proxy.jaden-wise.workers.dev";

/* =========================================================
   DOM REFERENCES
========================================================= */
const siteSelect = document.getElementById("siteSelect");
const clientSelect = document.getElementById("clientSelect");
const personSelect = document.getElementById("personSelect");
const upsTracking = document.getElementById("upsTracking");
const submitBtn = document.getElementById("submitBtn");

/* =========================================================
   LOAD DROPDOWNS (FROM CLOUDFLARE)
========================================================= */
async function loadDropdown(type, targetId) {
  const target = document.getElementById(targetId);

  if (!target) {
    console.error("Dropdown target not found:", targetId);
    return;
  }

  // âœ… Clear existing options (IMPORTANT)
  target.innerHTML = "";

  // Add placeholder for <select>
  if (target.tagName === "SELECT") {
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Selectâ€¦";
    target.appendChild(placeholder);
  }

  try {
    const res = await fetch(`${API_BASE}/dropdown`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type })
    });

    const data = await res.json();

    if (!Array.isArray(data)) {
      console.error("Dropdown error:", data);
      return;
    }

    data.forEach(value => {
      const opt = document.createElement("option");
      opt.value = value;
      opt.textContent = value;
      target.appendChild(opt);
    });

  } catch (err) {
    console.error("Dropdown fetch failed:", err);
  }
}
// ðŸ”¥ LOAD DROPDOWNS ON PAGE LOAD
loadDropdown("sites", "siteSelect");
loadDropdown("clients", "clientSelect");
loadDropdown("people", "personList");
/* =========================================================
   SCANNING + DUPLICATE UX
========================================================= */
const globalScans = new Set();
const scanBuckets = { nonVeho: [], damaged: [], undeliverable: [] };

document.querySelectorAll("input[type=checkbox]").forEach(cb => {
  cb.addEventListener("change", () => {
    const section = document.getElementById(cb.value);
    section.classList.toggle("hidden", !cb.checked);
    if (cb.checked) section.querySelector(".scan-input").focus();
  });
});

document.querySelectorAll(".section").forEach(section => {
  const key = section.id;
  const input = section.querySelector(".scan-input");
  const list = section.querySelector(".list");
  const count = section.querySelector(".count");

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      const value = input.value.trim();
      if (!value) return;

      const li = document.createElement("li");

      if (globalScans.has(value)) {
        li.textContent = `âš ï¸ ${value} â€” Duplicate (not captured)`;
        li.classList.add("duplicate");
        list.appendChild(li);
        input.value = "";
        return;
      }

      globalScans.add(value);
      scanBuckets[key].push(value);

      li.textContent = `âœ” ${value}`;
      list.appendChild(li);
      count.textContent = scanBuckets[key].length;
      input.value = "";
    }
  });
});

function undo(key) {
  const last = scanBuckets[key].pop();
  if (!last) return;
  globalScans.delete(last);
  const section = document.getElementById(key);
  section.querySelector(".list").lastChild.remove();
  section.querySelector(".count").textContent = scanBuckets[key].length;
}

function clearSection(key) {
  scanBuckets[key].forEach(v => globalScans.delete(v));
  scanBuckets[key] = [];
  const section = document.getElementById(key);
  section.querySelector(".list").innerHTML = "";
  section.querySelector(".count").textContent = "0";
}

/* =========================================================
   SUBMISSION
========================================================= */
submitBtn.addEventListener("click", submitReturn);

async function submitReturn() {
  if (!siteSelect.value || !clientSelect.value || !personSelect.value) {
    alert("Site, Client, and Returned By are required.");
    return;
  }

  if (!upsTracking.value.trim()) {
    alert("UPS Tracking Number is required.");
    return;
  }

  if (globalScans.size === 0) {
    alert("No unique packages captured.");
    return;
  }

  const payload = {
    site: siteSelect.value,
    client: clientSelect.value,
    returnedBy: personSelect.value,
    upsTracking: upsTracking.value,
    packages: scanBuckets
  };

  const res = await fetch(`${API_BASE}/submit`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();

  if (!res.ok) {
    alert(result.error || "Submission failed.");
    return;
  }

  alert("Return successfully submitted.");
  location.reload();
}
</script>

</body>
</html>



